(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2482],{1235:e=>{e.exports={add:"Right_add__aC9CL"}},7978:e=>{e.exports={task:"styles_task__Am_dW",snap:"styles_snap__WXTZS"}},15093:e=>{e.exports={border:"Border_border__xN_6B",hover:"Border_hover__HZnzf",selected:"Border_selected__kggRn"}},23973:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>ew});var l=i(54568),s=i(7620),n=i(65205),r=function(e){return e.Group="group",e.TaskCard="taskCard",e}({}),d=function(e){return e.NOT_DUE="未到期",e.NOT_FATHER="前置任务未完成",e.NOT_STARTED="待开始",e.IN_PROGRESS="进行中",e.TIMEOUT="超时",e.COMPLETED="已完成",e.FAILED="失败",e}({}),a=i(53979),o=i(45447),u=i(15093),c=i.n(u);let h=e=>{let{style:t="",children:i,selected:s,isHovered:n}=e;return(0,l.jsx)("div",{className:(0,o.pS)(c().border,n&&c().hover,s&&c().selected,t),children:i})};var v=i(30538);let m=e=>{let{children:t}=e,{isHovered:i,hoverProps:s}=(0,v.useHovered)();return(0,l.jsx)("div",{...s,children:t({isHovered:i})})};var p=i(78032),x=i.n(p),g=i(31721),f=i.n(g);class y{add(e){let t=Array.isArray(e)?e:[e];return this.items.push(...t),this}remove(e){let t=(Array.isArray(e)?e:[e]).map(e=>e.id);return this.items=this.items.filter(e=>!t.includes(e.id)),this}removeById(e){let t=Array.isArray(e)?e:[e];return this.items=this.items.filter(e=>!t.includes(e.id)),this}removeManyBy(e){return this.items=this.items.filter(t=>!e(t)),this}removeManyByWhere(e){return this.items=this.items.filter(t=>!Object.entries(e).every(e=>{let[i,l]=e;return t[i]===l})),this}update(e){return(Array.isArray(e)?e:[e]).forEach(e=>{let t=this.items.findIndex(t=>t.id===e.id);-1!==t&&(this.items[t]=e)}),this}updateById(e,t){return(Array.isArray(e)?e:[e]).forEach(e=>{let i=this.items.findIndex(t=>t.id===e);-1!==i&&(this.items[i]={...this.items[i],...t})}),this}updateManyBy(e){return this.items=this.items.map(t=>e(t)),this}updateManyByWhere(e,t){return this.items=this.items.map(i=>Object.entries(e).every(e=>{let[t,l]=e;return i[t]===l})?{...i,...t}:i),this}findById(e){return this.items.find(t=>t.id===e)}findBy(e){return this.items.find(e)}findManyBy(e){return this.items.filter(e)}findManyByWhere(e){return this.items.filter(t=>Object.entries(e).every(e=>{let[i,l]=e;return t[i]===l}))}has(e){return this.items.some(t=>t.id===e.id)}hasById(e){return this.items.some(t=>t.id===e)}result(){return f().cloneDeep(this.items)}constructor(e=[]){this.items=e}}let j="preview-node",E=e=>({id:Date.now().toString(),type:e,position:{x:0,y:0},data:{title:""}}),N=(e,t)=>({id:Date.now().toString(),type:"smoothstep",source:e,target:t}),b=(e,t)=>{let i=E(t),l=N(e.id,i.id);return{node:i,edge:l}},D=(e,t)=>({id:"preview-edge",source:e,target:t,type:"smoothstep",animated:!0,style:{opacity:.5,strokeDasharray:"5,5",stroke:"#6495ED",strokeWidth:2.5}}),w=e=>({...e,id:j,draggable:!1,style:{...e.style,opacity:.5,outline:"dashed 2.5px rgba(24, 144, 255, 1)",borderRadius:4,backgroundColor:"#fff"}}),C=e=>{let{edges:t,nodes:i}=e,l=new(x()).graphlib.Graph().setDefaultEdgeLabel(()=>({}));return l.setGraph({rankdir:"LR",nodesep:10,ranksep:50}),null==t||t.forEach(e=>l.setEdge(e.source,e.target)),null==i||i.forEach(e=>{var t,i,s,n;l.setNode(e.id,{...e,width:null!==(s=null===(t=e.measured)||void 0===t?void 0:t.width)&&void 0!==s?s:0,height:null!==(n=null===(i=e.measured)||void 0===i?void 0:i.height)&&void 0!==n?n:0})}),x().layout(l),{edges:t,nodes:null==i?void 0:i.map(e=>{var t,i,s,n;let r=l.node(e.id),d=r.x-("taskCard"===e.type?(null!==(s=null===(t=e.measured)||void 0===t?void 0:t.width)&&void 0!==s?s:0)/3:0),a=r.y-(null!==(n=null===(i=e.measured)||void 0===i?void 0:i.height)&&void 0!==n?n:0)/2;return{...e,position:{x:d,y:a}}})}},k=e=>{let{nodes:t,edges:i}=e;return t.forEach(e=>{var l;if((null===(l=e.style)||void 0===l?void 0:l.display)==="none")return;let{descendantNodes:s,descendantEdges:n}=A(e,t,i);s.forEach(t=>{t.style={display:e.data.fold?"none":"block"}}),n.forEach(t=>{t.style={display:e.data.fold?"none":"block"}})}),{nodes:t,edges:i}},_=(e,t)=>Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),T=(e,t)=>{let i=new Map;t.forEach(e=>{var t;i.has(e.source)||i.set(e.source,[]),null===(t=i.get(e.source))||void 0===t||t.push(e.target)});let l=[],s=new Set,n=[e.id];for(;n.length>0;){let e=n.shift();(i.get(e)||[]).forEach(e=>{s.has(e)||(s.add(e),l.push(e),n.push(e))})}return l},O=(e,t,i)=>{let l=T(e,i);return t.filter(e=>l.includes(e.id))},M=(e,t)=>{let i=[];return t.forEach(t=>{t.target!==e.id||i.includes(t.source)||i.push(t.source)}),i},S=(e,t,i)=>{let l=M(e,i);return t.filter(e=>l.includes(e.id))},A=(e,t,i)=>{let l=T(e,i),s=i.filter(e=>l.includes(e.target)).map(e=>e.id);return{descendantIds:l,descendantEdgeIds:s,descendantNodes:t.filter(e=>l.includes(e.id)),descendantEdges:i.filter(e=>s.includes(e.id))}},R=(e,t)=>t.filter(t=>t.source===e.id||t.target===e.id),I=e=>{let{node:t,nodes:i,descendantIds:l}=e;if(!t||!(null==i?void 0:i.length))return i;let s=i.find(e=>e.id===t.id);if(!s)return i;let n=t.position.x-s.position.x,r=t.position.y-s.position.y;return new y(i).updateManyBy(e=>(((null==l?void 0:l.includes(e.id))||t.id===e.id)&&(e.position.x+=n,e.position.y+=r,e.style={...e.style,zIndex:1}),e)).result()},B=e=>{let t;let{node:i,nodes:l,edges:s,intersectingNodes:n}=e,d=T(i,s);if(i&&(null==l?void 0:l.length)){if((null==n?void 0:n.length)===1&&n[0]&&n[0].id!==j)t=n[0];else{var a,o,u;let e=l.map(e=>({node:e,distance:_(i.position,e.position)})).filter(e=>e.node.id!==i.id&&!d.includes(e.node.id)).sort((e,t)=>e.distance-t.distance);150>((null===(a=e[0])||void 0===a?void 0:a.distance)||0)&&(null===(o=e[0])||void 0===o?void 0:o.node.id)!==j&&(t=null===(u=e[0])||void 0===u?void 0:u.node)}return i.type===r.Group&&(null==t?void 0:t.type)===r.TaskCard&&(t=void 0),t}},H=e=>{let{parentNode:t,type:i,selected:s}=e,{addNodes:r,addEdges:d}=(0,n.VH)();return(0,l.jsx)("div",{onClick:()=>{let{node:e,edge:l}=b(t,i);r(e),d(l)},children:(0,l.jsx)(a.z6Y,{style:{color:"rgba(24, 144, 255, ".concat(s?1:.5,")"),fontSize:14,cursor:"copy",backgroundColor:"#fff"}})})},F=()=>{let{getNodes:e,getEdges:t,setNodes:i,setEdges:l,fitView:s}=(0,n.VH)(),r=e(),d=t(),a=r.some(e=>e.dragging);return{nodes:r,edges:d,setNodes:i,setEdges:l,isDragging:a,fitView:s}},P=[E(r.Group)],V=[];var L=i(38993);let U=()=>{let[e,t,i]=(0,n.ck)([]),[l,r,d]=(0,n.fM)([]),{fitView:a}=F(),u=(0,s.useRef)(null),c=L.F.taskNode.findMany.useQuery(),h=L.F.taskEdge.findMany.useQuery();return(0,s.useEffect)(()=>{var i,s,n;if(c.isLoading||(null==e?void 0:e.length)||h.isLoading||(null==l?void 0:l.length))return;let d=(null==c?void 0:null===(i=c.data)||void 0===i?void 0:i.map(e=>({...e,position:{x:0,y:0}})))||[],v=h.data||[],m=(null==c?void 0:null===(s=c.data)||void 0===s?void 0:s.length)?d:P,p=(null==h?void 0:null===(n=h.data)||void 0===n?void 0:n.length)?v:V;u.current={nodes:o._.cloneDeep(d),edges:o._.cloneDeep(v)},t(m),r(p),setTimeout(()=>{a()},200)},[h,null==l?void 0:l.length,a,c,null==e?void 0:e.length,r,t]),{nodes:e,edges:l,setNodes:t,setEdges:r,onNodesChange:i,onEdgesChange:d,prevStateRef:u}},W=e=>{let{nodes:t,edges:i,prevStateRef:l}=e,{nodes:s,edges:n}=l.current||{},r=L.F.taskNode.create.useMutation(),d=L.F.taskNode.update.useMutation(),a=L.F.taskNode.delete.useMutation(),u=L.F.taskEdge.create.useMutation(),c=L.F.taskEdge.update.useMutation(),h=L.F.taskEdge.delete.useMutation();return(0,v.useDebouncedEffect)(async()=>{if(!s||!n)return;let e=t.filter(e=>{let t=s.find(t=>t.id===e.id);return t&&JSON.stringify(t.data)!==JSON.stringify(e.data)}),v=t.filter(e=>!s.find(t=>t.id===e.id)),m=s.filter(e=>!t.find(t=>t.id===e.id)),p=i.filter(e=>{let t=n.find(t=>t.id===e.id);return t&&t.target===e.target&&t.source!==e.source}),x=i.filter(e=>!n.find(t=>t.id===e.id)),g=n.filter(e=>!i.find(t=>t.id===e.id)),f={nodesToCreate:v.length,nodesToUpdate:e.length,nodesToDelete:m.length,edgesToCreate:x.length,edgesToUpdate:p.length,edgesToDelete:g.length};Object.values(f).reduce((e,t)=>e+t,0)>0&&console.log(666,"变更统计",f),await Promise.all([...e.map(e=>d.mutateAsync({where:{id:e.id},data:o._.pick(e,["data"])})),...v.map(e=>r.mutateAsync({data:o._.pick(e,["id","type","data"])})),...m.map(e=>a.mutateAsync({where:{id:e.id}}))]),await Promise.all([...x.map(e=>u.mutateAsync({data:o._.pick(e,["id","type","source","target"])})),...p.map(e=>c.mutateAsync({where:{id:e.id},data:o._.pick(e,["source","target"])})),...g.map(e=>{h.mutateAsync({where:{id:e.id}})})]),l.current={nodes:o._.cloneDeep(t),edges:o._.cloneDeep(i)}},[t,i]),{prevStateRef:l}},G=e=>{let{nodes:t=[],edges:i=[],setEdges:l,setNodes:s}=e,n=o._.cloneDeep(t),r=o._.cloneDeep(i);return{onKeyDown:e=>{var d;let a=e.target.dataset.id,o=t.find(e=>e.id===a),u=null===(d=i.find(e=>e.target===a))||void 0===d?void 0:d.source,c=t.find(e=>e.id===u);if("Enter"===e.key){if(!c||!(null==o?void 0:o.type))return;let{node:e,edge:t}=b(c,o.type),i=n.find(e=>e.id===o.id);i&&(i.selected=!1),e.selected=!0,e.data.editing=!0,n.push(e),s(n),r.push(t),l(r)}}}};var Y=i(7978),z=i.n(Y);let q=e=>{var t,i;let{nodes:l=[],edges:r=[],setEdges:d}=e,{getIntersectingNodes:a}=(0,n.VH)(),[u,c]=(0,s.useState)(null),h=(e,t)=>{let i=a(e);return B({node:e,nodes:t,edges:r,intersectingNodes:i})};return{onNodeDrag:(e,t)=>{let i=o._.cloneDeep(l),s=o._.cloneDeep(r);i=I({node:t,nodes:i,descendantIds:T(t,r)});let n=h(t,i);if(n){var d;s=s.filter(e=>e.target!==t.id);let e=w(t);s.push(D(n.id,e.id)),i.push(e);let{nodes:l}=C({nodes:i,edges:s});e.position=(null==l?void 0:null===(d=l.find(t=>t.id===e.id))||void 0===d?void 0:d.position)||e.position,i.forEach(e=>{var t,i;e.id===(null==n?void 0:n.id)?(null===(t=e.className)||void 0===t?void 0:t.includes(z().snap))||(e.className=(e.className||"")+z().snap):e.className=null===(i=e.className)||void 0===i?void 0:i.replace(z().snap,"")})}c({nodes:i,edges:s})},onNodeDragStop:(e,t)=>{let i=o._.cloneDeep(l),s=o._.cloneDeep(r),n=s.find(e=>e.target===t.id),a=h(t,i);if(a){var u;n?n.source=a.id:s.push(N(a.id,t.id)),d(s),a.className=null===(u=a.className)||void 0===u?void 0:u.replace(z().snap,"")}c(null)},preview:u,isPreview:!!((null==u?void 0:null===(t=u.nodes)||void 0===t?void 0:t.length)||(null==u?void 0:null===(i=u.edges)||void 0===i?void 0:i.length))}},X=e=>{let{isPreview:t,onEdgesChange:i,onNodesChange:s}=e,{nodes:n,edges:r}=F(),d=e=>{let t=R(e,r);t.length>0&&i(t.map(e=>({...e,type:"remove"})))};return{onNodesChange:e=>{if(t)return;let i=e.filter(e=>"remove"===e.type);i.length>0?a.aFV.confirm({title:"确定要删除选中的节点吗",content:(0,l.jsxs)("div",{children:[(0,l.jsx)(a.Sc0,{checked:!0}),(0,l.jsx)("span",{className:"ml-1",children:"是否删除所有子节点"})]}),onOk:()=>{s(i),i.forEach(e=>{d(e)}),i.forEach(e=>{let t=O(e,n,r);s(t.map(e=>({id:e.id,type:"remove"}))),t.forEach(e=>{d(e)})})}}):s(e)},onEdgesChange:e=>{if(t)return;let l=e.filter(e=>!["remove"].includes(e.type));l.length>0&&i(l)}}},Q=e=>{let{nodes:t,edges:i,setNodes:l,setEdges:s,onNodesChange:n,onEdgesChange:r}=e,{onKeyDown:d}=G({nodes:t,edges:i,setNodes:l,setEdges:s}),{preview:a,isPreview:o,onNodeDrag:u,onNodeDragStop:c}=q({nodes:t,edges:i,setNodes:l,setEdges:s});return{preview:a,onKeyDown:d,onNodeDrag:u,onNodeDragStop:c,...X({isPreview:o,onNodesChange:n,onEdgesChange:r})}},Z=e=>{let{nodes:t,edges:i,handles:l}=e,{setNodes:s,setEdges:n}=F();(0,v.useDebouncedEffect)(()=>{if(!(null==t?void 0:t.length)||!(null==i?void 0:i.length)||!t.every(e=>e.measured))return;let e=l.reduce((e,t)=>t(e),{nodes:t,edges:i});s(o._.cloneDeep(e.nodes)),n(o._.cloneDeep(e.edges))},[t,i],{wait:10})},J={[d.NOT_DUE]:"outline-gray-200 bg-gray-50",[d.NOT_FATHER]:"outline-gray-200 bg-gray-50",[d.NOT_STARTED]:"outline-gray-200 bg-white",[d.IN_PROGRESS]:"outline-blue-200 bg-blue-50",[d.TIMEOUT]:"outline-yellow-200 bg-yellow-50",[d.COMPLETED]:"outline-green-200 bg-green-100",[d.FAILED]:"outline-red-200 bg-red-100"},K=(e,t,i)=>{let{dates:l,result:s,executionRecords:n,preTaskStatus:a}=e.data,u=S(e,t,i).filter(e=>e.type===r.TaskCard).map(e=>({...e,data:{...e.data,status:e.data.status||K(e,t,i)}}));return(null==u?void 0:u.length)&&u.some(e=>{var t;return!(null==a?void 0:a.includes(null===(t=e.data)||void 0===t?void 0:t.status))})?d.NOT_FATHER:(null==l?void 0:l.length)?!0===s?d.COMPLETED:!1===s?d.FAILED:(0,o.yf)().isBefore((0,o.yf)(null==l?void 0:l[0]).startOf("day"))?d.NOT_DUE:(0,o.yf)().isAfter((0,o.yf)(null==l?void 0:l[1]).endOf("day"))?d.TIMEOUT:(null==n?void 0:n.length)?d.IN_PROGRESS:d.NOT_STARTED:d.NOT_DUE},$=(e,t,i)=>{let l=e.id===j?d.NOT_DUE:K(e,t,i);return{status:l,statusStyle:J[l]}},ee=e=>{let{parentNode:t}=e,{nodes:i,edges:s,setNodes:n}=F(),r=T(t,s).length;return(0,l.jsx)("div",{onClick:()=>{t.data.fold=!t.data.fold,n(new y(i).updateById(t.id,t).result())},children:t.data.fold?(0,l.jsx)("div",{style:{width:15,height:15,display:"flex",justifyContent:"center",alignItems:"center",color:"rgba(24, 144, 255, 1)",backgroundColor:"#fff",border:"1.5px solid rgba(24, 144, 255, 1)",fontSize:10,cursor:"pointer",borderRadius:"50%"},children:r}):(0,l.jsx)(a.MWI,{style:{color:"rgba(24, 144, 255, 1)",fontSize:14,backgroundColor:"#fff"}})})};var et=i(1235),ei=i.n(et);let el=e=>{let{children:t,parentNode:i,selected:s,isHovered:n,dragging:d,showAddBtn:a}=e,{edges:o}=F(),u=!!T(i,o).length,c=!s&&!d&&n&&u,h=s&&!d&&[void 0,!0].includes(a),v=s&&!d&&[void 0,!1].includes(a);return(0,l.jsxs)("div",{children:[t,(0,l.jsxs)("div",{className:ei().add,children:[h&&(0,l.jsx)(H,{type:r.Group,selected:s,parentNode:i}),v&&(0,l.jsx)(H,{type:r.TaskCard,selected:s,parentNode:i}),c&&(0,l.jsx)(ee,{parentNode:i})]})]})};var es=i(50389);let en=e=>{let{children:t}=e;return(0,l.jsxs)("div",{children:[t,(0,l.jsx)(n.h7,{type:"source",position:es.yX.Right,style:{visibility:"hidden"}}),(0,l.jsx)(n.h7,{type:"target",position:es.yX.Left,style:{visibility:"hidden"}})]})},er=e=>{var t,i;let{isEdit:s,value:n,onChange:r}=e;return s?(0,l.jsx)(a.lrV.RangePicker,{value:[(null==n?void 0:n[0])?(0,o.yf)(n[0]):null,(null==n?void 0:n[1])?(0,o.yf)(n[1]):null],onChange:e=>{r(null==e?void 0:e.map(e=>null==e?void 0:e.valueOf()))}}):(null==n?void 0:n.length)!==2?null:(0,l.jsxs)("div",{children:[null===(t=(0,o.yf)(n[0]))||void 0===t?void 0:t.format("YYYY-MM-DD")," 至 ",null===(i=(0,o.yf)(n[1]))||void 0===i?void 0:i.format("YYYY-MM-DD")]})},ed=e=>{let{isEdit:t,autoFocus:i,value:n,mode:r="input",onChange:d}=e,[o,u]=(0,s.useState)(n);(0,v.useDebounceEffect)(()=>{d(o)},[o]);let c="input"===r?a.pde:a.pde.TextArea;return t?(0,l.jsx)(c,{autoFocus:i,value:o,placeholder:"请输入内容",onChange:e=>{u(e.target.value||"")}}):(0,l.jsx)("div",{className:"overflow-hidden text-ellipsis whitespace-pre",style:{color:n?"":"#ddd"},children:n||"请输入内容"})},ea=(0,i(85493).vt)(e=>({isEditing:!1,setEditing:t=>{e({isEditing:t})},isExecuting:!1,setExecuting:t=>{e({isExecuting:t})}})),eo=e=>{let{isEdit:t,title:i,onChange:s}=e;return(0,l.jsx)("div",{className:"text-sm font-medium text-gray-900 truncate w-full",children:(0,l.jsx)("div",{style:{color:i?"":"#ccc"},children:(0,l.jsx)(ed,{isEdit:t,value:i,autoFocus:!0,onChange:e=>s({title:e})})})})},eu=e=>{let{isEdit:t,description:i="",onChange:s}=e;return t||i?(0,l.jsx)("div",{className:"mt-2 text-xs text-gray-700 line-clamp-2",children:(0,l.jsx)(ed,{mode:"textarea",isEdit:t,value:i,onChange:e=>s({description:e})})}):null},ec=e=>{let{isEdit:t,dates:i,onChange:s}=e;return t||(null==i?void 0:i.length)===2?(0,l.jsxs)("div",{className:"mt-1.5 flex items-center text-[11px] text-gray-400",children:[!t&&(0,l.jsx)(a.hOh,{className:"text-xs mr-1"}),(0,l.jsx)(er,{value:i,isEdit:t,onChange:e=>s({dates:e})})]}):null};var eh=i(223),ev=i.n(eh),em=i(87740),ep=i.n(em);ev().extend(ep());let ex=e=>{let t=e.reduce((e,t)=>e+ev()(t.end).diff(ev()(t.start)),0),i=ev().duration(t);return{hours:Math.floor(i.asHours()),minutes:i.minutes(),seconds:i.seconds()}},eg=e=>{let{hours:t,minutes:i,seconds:l}=e,s="";return t&&(s+="".concat(t,"h ")),i&&(s+="".concat(i,"m ")),l&&(s+="".concat(l,"s")),s},ef=(e,t)=>{let i=ev().duration(ev()(t).diff(ev()(e))),l=Math.floor(i.asHours());return eg({hours:l,minutes:i.minutes(),seconds:i.seconds()})},ey=e=>{let{executionRecords:t,isEdit:i,onChange:n}=e,[r,d]=(0,s.useState)(!1),{hours:u,minutes:c,seconds:h}=ex(t);return i?(0,l.jsxs)("div",{className:"mt-1.5",children:[(0,l.jsxs)("div",{className:"text-[11px] text-gray-600 mb-2",children:["总耗时：",eg({hours:u,minutes:c,seconds:h})]}),(0,l.jsx)(a.lVW,{initialValues:{executionRecords:t.map(e=>({start:(0,o.yf)(e.start),end:(0,o.yf)(e.end)}))},onValuesChange:(e,t)=>{null==n||n({executionRecords:t.executionRecords.map(e=>{var t,i;return{start:null===(t=e.start)||void 0===t?void 0:t.valueOf(),end:null===(i=e.end)||void 0===i?void 0:i.valueOf()}})})},children:(0,l.jsx)(a.lVW.List,{name:"executionRecords",children:(e,t)=>{let{add:i,remove:s}=t;return(0,l.jsxs)(l.Fragment,{children:[e.map(e=>{let{key:t,name:i,...n}=e;return(0,l.jsxs)("div",{className:"mb-2 flex items-center",children:[(0,l.jsx)(a.lVW.Item,{...n,noStyle:!0,name:[i,"start"],className:"mb-0 flex-1",rules:[{required:!0,message:"请选择开始时间"}],children:(0,l.jsx)(a.lrV,{showTime:!0,placeholder:"开始时间",className:"w-full",format:"DD HH:mm"})}),(0,l.jsx)("div",{className:"mx-1",children:"至"}),(0,l.jsx)(a.lVW.Item,{...n,noStyle:!0,name:[i,"end"],className:"mb-0 flex-1",children:(0,l.jsx)(a.lrV,{showTime:!0,placeholder:"结束时间",className:"w-full",format:"DD HH:mm"})}),(0,l.jsx)(a.$nd,{type:"text",className:"ml-2",icon:(0,l.jsx)(a.SUY,{}),onClick:()=>s(i)})]},t)}),(0,l.jsx)(a.lVW.Item,{children:(0,l.jsx)(a.$nd,{type:"dashed",onClick:()=>i({}),block:!0,icon:(0,l.jsx)(a.bW0,{}),className:"text-[11px]",children:"添加执行记录"})})]})}})})]}):(0,l.jsxs)("div",{className:"mt-1.5",children:[!!t.length&&(0,l.jsxs)("button",{onClick:()=>d(!r),className:"w-full flex items-center justify-between text-[11px] text-gray-500 hover:text-gray-600",children:[(0,l.jsxs)("span",{children:["总耗时：",eg({hours:u,minutes:c,seconds:h})]}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("span",{className:"mr-1",children:["共 ",t.length," 次执行"]}),r?(0,l.jsx)(a.k8Y,{className:"text-xs"}):(0,l.jsx)(a.lHd,{className:"text-xs"})]})]}),(0,l.jsx)("div",{className:"\n          overflow-hidden transition-all duration-300\n          ".concat(r?"max-h-[300px] opacity-100 mt-2":"max-h-0 opacity-0","\n        "),children:(0,l.jsx)("div",{className:"space-y-2",children:t.map((e,t)=>(0,l.jsx)("div",{className:"relative border-l border-gray-200",children:(0,l.jsxs)("div",{className:"flex flex-row pl-1 justify-between align-middle text-[11px]",children:[(0,l.jsx)("div",{className:"text-gray-400",style:{width:"33.33%"},children:(0,o.yf)(e.start).format("MM-DD HH:mm")}),(0,l.jsx)("div",{className:"text-gray-400",style:{width:"33.33%"},children:e.end?(0,o.yf)(e.end).format("MM-DD HH:mm"):"-"}),(0,l.jsx)("div",{className:"text-gray-400",style:{width:"33.33%",textAlign:"right"},children:ef(e.start,e.end)})]})},t))})})]})},ej=e=>{let{onClick:t}=e;return(0,l.jsx)("div",{className:"flex justify-end mb-1 absolute right-[-50px]",children:(0,l.jsx)("button",{onClick:t,className:"text-xs px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 hover:bg-blue-200",children:"完成"})})},eE=e=>{var t,i;let{status:n,executionRecords:r=[],onChange:o}=e,u=r[r.length-1],[c,{setTrue:h,setFalse:m}]=(0,v.useBoolean)(!!((null===(t=r[r.length-1])||void 0===t?void 0:t.start)&&!(null===(i=r[r.length-1])||void 0===i?void 0:i.end))),{setExecuting:p,isExecuting:x}=ea();return((0,s.useEffect)(()=>{p(c)},[c,p]),[d.NOT_DUE,d.NOT_FATHER,d.COMPLETED,d.FAILED].includes(n))?null:(0,l.jsxs)("div",{className:"flex items-center gap-1.5",children:[c&&(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("div",{className:"animate-spin h-2.5 w-2.5 border border-blue-500 border-t-transparent rounded-full"}),(0,l.jsx)("span",{className:"ml-1 text-[11px] text-blue-500 whitespace-nowrap",children:"执行中"})]}),(0,l.jsx)("button",{onClick:()=>{if(c)m(),u.end=Date.now(),o({executionRecords:r});else{if(u&&!u.end){a.iUO.error("请先结束上次执行");return}if(x){a.iUO.error("请先结束别的任务");return}h(),r.push({start:Date.now()}),o({executionRecords:r})}},className:"\n          p-0.5 rounded transition-colors\n          ".concat(c?"text-blue-500 hover:text-blue-600":"text-gray-400 hover:text-gray-500","\n        "),title:c?"停止执行":"开始执行",children:c?(0,l.jsx)(a.Xcy,{}):(0,l.jsx)(a.VgC,{})}),!!(null==u?void 0:u.end)&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("button",{onClick:()=>{o({result:!0})},className:"p-0.5 rounded text-green-500 hover:text-green-600 transition-colors",title:"标记完成",children:(0,l.jsx)(a.hWy,{})}),(0,l.jsx)("button",{onClick:()=>{o({result:!1})},className:"p-0.5 rounded text-red-500 hover:text-red-600 transition-colors",title:"标记失败",children:(0,l.jsx)(a.bBN,{})})]})]})},eN=e=>{let{isEdit:t,tags:i,onChange:s}=e;return t?(0,l.jsx)("div",{className:"mt-1.5 text-sm font-medium text-gray-900 truncate",style:{width:"100%"},children:(0,l.jsx)(a.l6P,{mode:"tags",style:{width:"100%"},placeholder:"请选择标签",value:i,onChange:e=>s({tags:e}),options:["需求","BUG","思考","临时","手机","电脑","外出","家里"].map(e=>({label:e,value:e}))})}):null},eb=e=>{let{isEdit:t,preTaskStatus:i=d.COMPLETED,onChange:s}=e;return t?(0,l.jsx)("div",{className:"mt-1.5 text-sm font-medium text-gray-900 truncate",style:{width:"100%"},children:(0,l.jsx)(a.l6P,{mode:"tags",style:{width:"100%"},placeholder:"请选择标签",value:i,onChange:e=>s({preTaskStatus:e}),options:[d.COMPLETED,d.IN_PROGRESS].map(e=>({label:e,value:e}))})}):null},eD={[r.Group]:e=>{let{selected:t,dragging:i,data:n}=e,{setEditing:r}=ea(),[d,o]=(0,s.useState)(!1);(0,s.useEffect)(()=>{r(d)},[d,r]),(0,s.useEffect)(()=>{n.editing&&(delete n.editing,o(!0),setTimeout(()=>{var e;return null===(e=document.querySelector("input"))||void 0===e?void 0:e.focus()},300))},[n,o]);let[u,c]=(0,s.useState)((null==e?void 0:e.data.title)||""),{nodes:v,edges:p,setNodes:x}=F(),g=(0,s.useMemo)(()=>{var t;let i=O(e,v,p);return i.length?(null===(t=i[0])||void 0===t?void 0:t.type)==="group":void 0},[p,v,e]),f=()=>{o(!0),c((null==e?void 0:e.data.title)||"")},y=e=>{c(e.target.value||"")},j=()=>{o(!1),x(t=>t.map(t=>t.id===e.id?{...t,data:{...t.data,title:u}}:t))},E=()=>{j()},N=e=>{"Enter"===e.key&&d&&j()};return(0,l.jsx)(en,{children:(0,l.jsx)(m,{children:s=>{let{isHovered:n}=s;return(0,l.jsx)(h,{selected:t,isHovered:n,children:(0,l.jsx)(el,{parentNode:e,showAddBtn:g,isHovered:n,selected:t,dragging:i,children:(0,l.jsx)("div",{style:{backgroundColor:"rgb(249, 250, 251)"},children:d?(0,l.jsx)("div",{style:{padding:5},onDragOver:e=>e.preventDefault(),children:(0,l.jsx)(a.pde,{autoFocus:!0,bordered:!1,value:u,onChange:y,onBlur:E,onKeyDown:N})}):(0,l.jsx)("div",{onDoubleClick:f,style:{padding:"5px 10px",color:(null==e?void 0:e.data.title)?"":"#ddd"},children:(null==e?void 0:e.data.title)||"双击编辑"})})})})}})})},[r.TaskCard]:e=>{let{selected:t,dragging:i,data:n}=e,{title:r,description:d,dates:a,tags:u,preTaskStatus:c,executionRecords:p=[]}=n,{nodes:x,edges:g,setNodes:f}=F(),[y,{setTrue:j,setFalse:E}]=(0,v.useBoolean)(!1),{setEditing:N}=ea();(0,s.useEffect)(()=>{N(y)},[y,N]),(0,s.useEffect)(()=>{n.editing&&(delete n.editing,j(),setTimeout(()=>{var e;return null===(e=document.querySelector("input"))||void 0===e?void 0:e.focus()},300))},[n,j]);let b=x.some(e=>e.dragging);(0,s.useEffect)(()=>{b&&E()},[b,E]);let{status:D,statusStyle:w}=$(e,x,g),C=t=>{f(i=>i.map(i=>i.id===e.id?{...i,data:{...i.data,...t}}:i))},k=()=>{void 0===n.result&&j()};return(0,l.jsx)(en,{children:(0,l.jsx)(m,{children:s=>{let{isHovered:n}=s;return(0,l.jsx)(h,{selected:t,isHovered:n,style:w,children:(0,l.jsx)(el,{parentNode:e,showAddBtn:!1,isHovered:n,selected:t,dragging:i,children:(0,l.jsx)("div",{className:"w-[280px] rounded-lg shadow-sm hover:shadow-md transition-shadow duration-300",children:(0,l.jsxs)("div",{className:"p-3",onDoubleClick:k,children:[y&&(0,l.jsx)(ej,{onClick:E}),(0,l.jsxs)("div",{className:"flex justify-between items-center",children:[(0,l.jsx)(eo,{title:r,isEdit:y,onChange:C}),!y&&(0,l.jsx)(eE,{status:D,onChange:C,executionRecords:o._.cloneDeep(p)})]}),(0,l.jsx)(ec,{dates:a,isEdit:y,onChange:C}),(0,l.jsx)(eu,{description:d,isEdit:y,onChange:C}),(0,l.jsx)(ey,{executionRecords:p,isEdit:y,onChange:C}),(0,l.jsx)(eN,{tags:u,isEdit:y,onChange:C}),(0,l.jsx)(eb,{preTaskStatus:c,isEdit:y,onChange:C})]})})})})}})})}},ew=()=>{let{isEditing:e}=ea(),{nodes:t,edges:i,prevStateRef:s,setNodes:r,setEdges:d,onEdgesChange:a,onNodesChange:o}=U();W({nodes:t,edges:i,prevStateRef:s});let{preview:u,...c}=Q({nodes:t,edges:i,setNodes:r,setEdges:d,onNodesChange:o,onEdgesChange:a});return Z({nodes:t,edges:i,handles:[k,C]}),(0,l.jsx)(n.Gc,{nodes:(null==u?void 0:u.nodes)||t,edges:(null==u?void 0:u.edges)||i,nodeTypes:eD,minZoom:1,maxZoom:1,fitView:!0,panOnDrag:!e,nodesDraggable:!e,selectNodesOnDrag:!1,fitViewOptions:{padding:.5},...c,children:(0,l.jsx)(n.VS,{})})}},38993:(e,t,i)=>{"use strict";let l;i.d(t,{TRPCReactProvider:()=>y,F:()=>g});var s=i(54568),n=i(7620),r=i(53979),d=i(90438),a=i(31354),o=i(68512),u=i(69415),c=i(43244),h=i(66688),v=i(45447),m=i(87606);i(24338);let p=()=>window.location.origin,x=()=>e=>{let{next:t,op:i}=e;return(0,c.sH)(e=>{let l=t(i).subscribe({next:t=>((0,v.uW)(i.type,i.path,i.input,t.result.data),e.next(t)),complete:()=>e.complete(),error:t=>{var i;r.iUO.error((null===(i=t.data)||void 0===i?void 0:i.formattedError)||t.message||"操作失败"),e.error(t)}});return()=>l.unsubscribe()})},g=(0,u.pY)(),f=null!=l?l:l=new a.E({defaultOptions:{queries:{staleTime:3e4},dehydrate:{serializeData:d.Ay.serialize,shouldDehydrateQuery:e=>(0,o.XS)(e)||"pending"===e.state.status},hydrate:{deserializeData:d.Ay.deserialize}}}),y=e=>{let[t]=(0,n.useState)(()=>g.createClient({links:[x,(0,h.kM)({transformer:d.Ay,url:p()+"/api/trpc",headers:()=>{let e=new Headers;return e.set("x-trpc-source","nextjs-react"),e}})]}));return(0,s.jsx)(m.QueryClientProvider,{client:f,children:(0,s.jsx)(g.Provider,{client:t,queryClient:f,children:e.children})})}},95348:(e,t,i)=>{Promise.resolve().then(i.bind(i,23973))}},e=>{var t=t=>e(e.s=t);e.O(0,[6854,9313,6410,541,6771,2602,1598,1815,8259,1210,1383,4129,2998,6502,5888,4030,794,9223,4033,9565,2983,3651,1026,959,5229,6411,1999,5533,587,8315,7358],()=>t(95348)),_N_E=e.O()}]);